openapi: 3.0.3
info:
  title: Agrarkarte Server API
  description: |
    REST API for agricultural data processing with authentication and file generation capabilities.
    
    This server provides endpoints for:
    - Health monitoring
    - User authentication via Authentik JWT
    - Shapefile generation for agricultural fields
    - KML generation with buffer zones for drone flight planning
  version: 1.0.0
  contact:
    name: Agrarkarte Team
  license:
    name: MIT

servers:
  - url: http://localhost:8081
    description: Development server

paths:
  /health:
    get:
      summary: Health check
      description: Returns the health status of the server
      tags:
        - Health
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Response'
              example:
                success: true
                message: "Server is healthy"

  /api/public:
    get:
      summary: Public endpoint
      description: Public endpoint accessible to everyone, shows authentication status
      tags:
        - Public
      security: []
      responses:
        '200':
          description: Public endpoint response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Response'

  /api/protected:
    get:
      summary: Protected endpoint
      description: Protected endpoint requiring JWT authentication
      tags:
        - Protected
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Protected endpoint response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Response'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/user/profile:
    get:
      summary: Get user profile
      description: Returns the authenticated user's profile information
      tags:
        - User
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User profile information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Response'
              example:
                success: true
                data:
                  id: "user123"
                  email: "user@example.com"
                  name: "John Doe"
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/generate-shapefile:
    post:
      summary: Generate shapefile
      description: Generates a shapefile from agricultural field data (requires authentication)
      tags:
        - File Generation
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateRequest'
            example:
              fields:
                - name: "Test Field"
                  geometry:
                    type: "Polygon"
                    coordinates: [[[0,0],[1,0],[1,1],[0,1],[0,0]]]
              prefix: "test"
              timestamp: "2024-01-01"
      responses:
        '200':
          description: Shapefile generated successfully
          content:
            application/zip:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              description: Attachment filename
              schema:
                type: string
                example: 'attachment; filename="agrarkarte_test_shapefile.zip"'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/generate-kml:
    post:
      summary: Generate KML with buffer zones
      description: |
        Generates KML files with buffer zones for drone flight planning.
        
        **Public endpoint** - No authentication required.
        
        Creates three KML files:
        - Original field polygons
        - Contingency volume (inner buffer)
        - Ground risk buffer (outer buffer)
        
        Buffer calculations are based on:
        - V0: Drone velocity in km/h
        - Characteristic Dimension: Physical size in meters
        - Flight Height: Operating altitude in meters
      tags:
        - File Generation
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/KMLRequest'
            example:
              fields:
                - name: "Test Field"
                  geometry:
                    type: "Polygon"
                    coordinates: [[[0,0],[1,0],[1,1],[0,1],[0,0]]]
              prefix: "test"
              timestamp: "2024-01-01"
              v0: 50
              characteristicDimension: 25
              flightHeight: 120
      responses:
        '200':
          description: KML files generated successfully
          content:
            application/zip:
              schema:
                type: string
                format: binary
              example: |
                ZIP archive containing:
                - test_original_fields.kml
                - test_contingency_volume.kml  
                - test_ground_risk_buffer.kml
          headers:
            Content-Disposition:
              description: Attachment filename
              schema:
                type: string
                example: 'attachment; filename="agrarkarte_test_kml.zip"'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/mission-package:
    post:
      summary: Generate mission package
      description: |
        Generates a complete mission package with all flight planning data.
        
        **Authenticated endpoint** - Requires JWT authentication.
        
        Includes:
        - Original field polygons with calculated zones
        - Contingency volumes and ground risk buffers
        - DIPUL intersection data (if available)
        - Flight parameters and calculated values
        - Mission metadata
        
        Returns a ZIP package containing all necessary files for drone mission planning.
      tags:
        - File Generation
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MissionPackageRequest'
            example:
              fields:
                - name: "Test Field"
                  geometry:
                    type: "Polygon"
                    coordinates: [[[0,0],[1,0],[1,1],[0,1],[0,0]]]
                  dipulZones:
                    - id: "zone123"
                      properties:
                        type_code: "restricted"
                        name: "No-fly zone"
                  contingencyVolume:
                    type: "Polygon"
                    coordinates: [[[0,0],[1,0],[1,1],[0,1],[0,0]]]
                  groundRiskBuffer:
                    type: "Polygon"
                    coordinates: [[[0,0],[1,0],[1,1],[0,1],[0,0]]]
              prefix: "mission"
              timestamp: "2024-01-01T12:00:00.000Z"
              calculatedValues:
                scv: 45.2
                sgrb: 12.8
                hcv: 135.0
                hfg: 100.0
              dipulCheckActive: true
              metadata:
                totalFields: 1
                hasGrbCvCalculated: true
                dipulCheckCompleted: true
      responses:
        '200':
          description: Mission package generated successfully
          content:
            application/zip:
              schema:
                type: string
                format: binary
              example: |
                ZIP archive containing:
                - fields.kml (original field boundaries)
                - contingency_volumes.kml
                - ground_risk_buffers.kml
                - dipul_zones.kml (if DIPUL data available)
                - mission_data.json (flight parameters and metadata)
          headers:
            Content-Disposition:
              description: Attachment filename
              schema:
                type: string
                example: 'attachment; filename="mission-package.zip"'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from Authentik authentication server

  schemas:
    Response:
      type: object
      properties:
        success:
          type: boolean
          description: Indicates if the request was successful
        message:
          type: string
          description: Human-readable message
        data:
          type: object
          description: Response data (varies by endpoint)
      required:
        - success

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error type identifier
        message:
          type: string
          description: Human-readable error message
      required:
        - error
        - message

    User:
      type: object
      properties:
        id:
          type: string
          description: Unique user identifier
        email:
          type: string
          format: email
          description: User's email address
        name:
          type: string
          description: User's display name
      required:
        - id
        - email
        - name

    Geometry:
      type: object
      properties:
        type:
          type: string
          enum: [Polygon]
          description: GeoJSON geometry type
        coordinates:
          type: array
          description: GeoJSON coordinates array
          items:
            type: array
            items:
              type: array
              items:
                type: number
      required:
        - type
        - coordinates

    Field:
      type: object
      properties:
        name:
          type: string
          description: Name of the agricultural field
          maxLength: 254
        geometry:
          $ref: '#/components/schemas/Geometry'
      required:
        - name
        - geometry

    GenerateRequest:
      type: object
      properties:
        fields:
          type: array
          description: Array of agricultural fields
          items:
            $ref: '#/components/schemas/Field'
          minItems: 1
        prefix:
          type: string
          description: Prefix for generated filenames
          example: "farm_2024"
        timestamp:
          type: string
          description: Timestamp for the generation request
          example: "2024-01-01"
      required:
        - fields
        - prefix
        - timestamp

    KMLRequest:
      type: object
      properties:
        fields:
          type: array
          description: Array of agricultural fields
          items:
            $ref: '#/components/schemas/Field'
          minItems: 1
        prefix:
          type: string
          description: Prefix for generated filenames
          example: "drone_mission"
        timestamp:
          type: string
          description: Timestamp for the generation request
          example: "2024-01-01"
        v0:
          type: number
          format: float
          description: Drone velocity in km/h
          minimum: 0.1
          maximum: 200
          example: 50
        characteristicDimension:
          type: number
          format: float
          description: Characteristic dimension of the drone in meters
          minimum: 0.1
          maximum: 100
          example: 25
        flightHeight:
          type: number
          format: float
          description: Flight height in meters
          minimum: 1
          maximum: 500
          example: 120
      required:
        - fields
        - prefix
        - timestamp
        - v0
        - characteristicDimension
        - flightHeight

    MissionPackageRequest:
      type: object
      properties:
        fields:
          type: array
          description: Array of agricultural fields with calculated data
          items:
            $ref: '#/components/schemas/MissionField'
          minItems: 1
        prefix:
          type: string
          description: Prefix for generated filenames
          example: "mission_alpha"
        timestamp:
          type: string
          format: date-time
          description: ISO timestamp for the generation request
          example: "2024-01-01T12:00:00.000Z"
        calculatedValues:
          $ref: '#/components/schemas/CalculatedValues'
        dipulCheckActive:
          type: boolean
          description: Whether DIPUL checking was enabled
          example: true
        metadata:
          $ref: '#/components/schemas/MissionMetadata'
      required:
        - fields
        - prefix
        - timestamp
        - calculatedValues
        - dipulCheckActive
        - metadata

    MissionField:
      type: object
      properties:
        name:
          type: string
          description: Name of the agricultural field
          maxLength: 254
        geometry:
          $ref: '#/components/schemas/Geometry'
        dipulZones:
          type: array
          description: DIPUL restriction zones intersecting this field
          items:
            $ref: '#/components/schemas/DipulZone'
        contingencyVolume:
          $ref: '#/components/schemas/Geometry'
          description: Calculated contingency volume geometry
        groundRiskBuffer:
          $ref: '#/components/schemas/Geometry'
          description: Calculated ground risk buffer geometry
      required:
        - name
        - geometry

    DipulZone:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier for the DIPUL zone
        properties:
          type: object
          properties:
            name:
              type: string
              description: Display name of the zone
            type_code:
              type: string
              description: Type classification code
            lower_limit_unit:
              type: string
              description: Units for altitude limits
            lower_limit_alt_ref:
              type: string
              description: Altitude reference system
            lower_limit_altitude:
              type: string
              description: Lower altitude limit
            legal_ref:
              type: string
              description: Legal reference or regulation
            external_reference:
              type: string
              description: External reference identifier
          required:
            - type_code
      required:
        - id
        - properties

    CalculatedValues:
      type: object
      properties:
        scv:
          type: number
          format: float
          description: Horizontal contingency volume distance in meters
          example: 45.2
        sgrb:
          type: number
          format: float
          description: Ground risk buffer distance in meters
          example: 12.8
        hcv:
          type: number
          format: float
          description: Vertical contingency volume height in meters
          example: 135.0
        hfg:
          type: number
          format: float
          description: Flight geography height in meters
          example: 100.0
      required:
        - scv
        - sgrb
        - hcv
        - hfg

    MissionMetadata:
      type: object
      properties:
        totalFields:
          type: integer
          description: Total number of fields in the mission
          minimum: 1
          example: 3
        hasGrbCvCalculated:
          type: boolean
          description: Whether GRB/CV values were calculated
          example: true
        dipulCheckCompleted:
          type: boolean
          description: Whether DIPUL checking was completed
          example: true
      required:
        - totalFields
        - hasGrbCvCalculated
        - dipulCheckCompleted

  responses:
    BadRequest:
      description: Bad request - Invalid input parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            emptyFields:
              summary: Empty fields array
              value:
                error: "Invalid field data"
                message: "Fields array is required"
            invalidVelocity:
              summary: Invalid velocity
              value:
                error: "Invalid parameters"
                message: "V0 (velocity) must be greater than 0"
            invalidDimension:
              summary: Invalid characteristic dimension
              value:
                error: "Invalid parameters"
                message: "Characteristic dimension must be greater than 0"
            invalidHeight:
              summary: Invalid flight height
              value:
                error: "Invalid parameters"
                message: "Flight height must be greater than 0"

    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "Authentication required"
            message: "Please log in to access this feature"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            shapefileGeneration:
              summary: Shapefile generation failed
              value:
                error: "Generation failed"
                message: "Unable to generate files"
            kmlGeneration:
              summary: KML generation failed
              value:
                error: "Generation failed"
                message: "Unable to generate KML files"

tags:
  - name: Health
    description: Server health monitoring
  - name: Public
    description: Public endpoints accessible without authentication
  - name: Protected
    description: Protected endpoints requiring authentication
  - name: User
    description: User management and profile operations
  - name: File Generation
    description: File generation services for agricultural data

externalDocs:
  description: Project README
  url: https://github.com/your-org/agrarkarte-server